trigger:
- main

resources:
  repositories:
  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release

variables:
- name: toolchainFeed
  value: https://onedrive.pkgs.visualstudio.com/b52099a6-3b13-4b08-9270-a07884a10e3d/_packaging/RustTools/nuget/v3/index.json
- name: cratesIoFeed
  value: sparse+https://onedrive.pkgs.visualstudio.com/b52099a6-3b13-4b08-9270-a07884a10e3d/_packaging/RustCratesIO/Cargo/index/

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    sdl:
      clippy: 
        enabled: false
      sourceAnalysisPool:
        # SDL tools only support Windows.
        name: Azure-Pipelines-1ESPT-ExDShared
        os: windows
        image: windows-latest
    stages:

    ## For more details on the Rust build workflow, see https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-docs/1es-pipeline-templates/features/buildworkflows/rust
    - stage: BuildStage
      displayName: üèóÔ∏è Cargo build
      jobs:
          - job: BuildJob
            displayName: üèóÔ∏è Cargo build
            pool:
              name: Azure-Pipelines-1ESPT-ExDShared
              os: windows
              image: windows-latest
            templateContext:
              type: buildJob
              workflow: Rust
              rust:
                rustToolchain:
                  version: ms-prod-1.88
                  toolchainFeed: $(toolchainFeed)
                  cratesIoFeed: $(cratesIoFeed)
                target: x86_64-pc-windows-msvc
                command: custom
              sdl:
                componentgovernance:
                  enabled: true
                  failOnAlert: true
              postBuildSteps:
                - script: |
                    echo "Running post-build steps..."
                    echo Add your post-build commands here
                  displayName: "Post-build steps"