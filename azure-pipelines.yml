trigger:
- main

resources:
  repositories:
  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release

variables:
- name: toolchainFeed
  value: https://onedrive.pkgs.visualstudio.com/b52099a6-3b13-4b08-9270-a07884a10e3d/_packaging/RustTools/nuget/v3/index.json
- name: cratesIoFeed
  value: sparse+https://onedrive.pkgs.visualstudio.com/b52099a6-3b13-4b08-9270-a07884a10e3d/_packaging/RustCratesIO/Cargo/index/

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    sdl:
      clippy: 
        enabled: false
      sourceAnalysisPool:
        # SDL tools only support Windows.
        name: Azure-Pipelines-1ESPT-ExDShared
        os: windows
        image: windows-latest
    stages:

    ## For more details on the Rust build workflow, see https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-docs/1es-pipeline-templates/features/buildworkflows/rust
    - stage: BuildStage
      displayName: ðŸ—ï¸ Cargo build
      jobs:
          - job: BuildJob
            displayName: ðŸ—ï¸ Cargo build
            pool:
              name: Azure-Pipelines-1ESPT-ExDShared
              os: windows
              image: windows-latest
            templateContext:
              type: buildJob
              workflow: Rust
              rust:
                rustToolchain:
                  version: ms-prod-1.90
                  toolchainFeed: $(toolchainFeed)
                  cratesIoFeed: $(cratesIoFeed)
                target: x86_64-pc-windows-msvc
                command: custom
              sdl:
                componentgovernance:
                  enabled: true
                  failOnAlert: true
              postBuildSteps:
                - script: |
                    cargo build --workspace --locked 2>&1

                  displayName: "Build debug"

                - script: |
                    cargo install junit-test
                    junit-test
                    copy junit.xml $(System.DefaultWorkingDirectory)\TEST-rust.xml
                    rd /s /q target\debug
                  displayName: 'Test debug'

                - task: PublishTestResults@2
                  displayName: 'Publish Test Results **/TEST-*.xml'
                  inputs:
                    mergeTestResults: true

                - script: |
                    set RUSTFLAGS=-Ccontrol-flow-guard -Ctarget-feature=+crt-static,+avx2,+lzcnt -Clink-args=/DYNAMICBASE -Clink-args=/CETCOMPAT
                    cargo build --workspace --locked --release 2>&1
                    copy target\release\lepton_jpeg.dll target\release\lepton_jpeg_avx2.dll
                    copy target\release\lepton_jpeg.pdb target\release\lepton_jpeg_avx2.pdb
                    copy target\release\lepton_jpeg_util.exe target\release\lepton_jpeg_util_avx2.exe
                    copy target\release\lepton_jpeg_util.pdb target\release\lepton_jpeg_util_avx2.pdb
                    set RUSTFLAGS=-Ccontrol-flow-guard -Ctarget-feature=+crt-static -Clink-args=/DYNAMICBASE -Clink-args=/CETCOMPAT
                    cargo build --workspace --locked --release 2>&1

                  displayName: 'Build Release'
                  
                - task: UseDotNet@2
                  inputs:
                    packageType: 'sdk'
                    version: '6.x'
              
                - task: EsrpCodeSigning@5
                  inputs:
                    ConnectedServiceName: 'ESRP CodeSigningV2-OneDrive Service'
                    AppRegistrationClientId: 'bd3fbc52-4cf5-4cca-a25d-94160e5ed309' 
                    AppRegistrationTenantId: 'cdc5aeea-15c5-4db6-b079-fcadd2505dc2' 
                    AuthAKVName: 'ODSP-ESRP' 
                    AuthCertName: 'ODSP-ESRP-Auth-V2' 
                    AuthSignCertName: 'CodeSigningCertificate'
                    FolderPath: '$(Build.SourcesDirectory)'
                    Pattern: '
                      target\release\lepton_jpeg.dll,
                      target\release\lepton_jpeg_avx2.dll,
                      target\release\lepton_jpeg_util.exe,
                      target\release\lepton_jpeg_util_avx2.exe'
                    signConfigType: 'inlineSignParams'
                    inlineOperation: |
                      [
                      {
                        "KeyCode": "CP-401405",
                        "OperationCode": "SigntoolSign",
                        "ToolName": "sign",
                        "ToolVersion": "1.0",
                        "Parameters": {
                        "OpusName": "Microsoft",
                        "OpusInfo": "https://www.microsoft.com",
                        "FileDigest": "/fd SHA256",
                        "PageHash": "/NPH",
                        "TimeStamp": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
                        }
                      },
                      {
                        "KeyCode": "CP-401405",
                        "OperationCode": "SigntoolVerify",
                        "ToolName": "sign",
                        "ToolVersion": "1.0",
                        "Parameters": {}
                      }
                      ]
                    SessionTimeout: '60'
                    MaxConcurrency: '50'
                    MaxRetryAttempts: '5'
                    PendingAnalysisWaitTimeoutMinutes: '5'

                - task: CopyFiles@2
                  displayName: 'Copy Rust output files to: $(Build.ArtifactStagingDirectory) copy'
                  inputs:
                    SourceFolder: '$(Build.SourcesDirectory)'
                    Contents: |
                      target\debug\?(*.dll|*.exe|*.pdb)
                      target\release\?(*.dll|*.exe|*.pdb)
                    
                    TargetFolder: '$(Build.ArtifactStagingDirectory)'

                - task: PublishSymbols@2
                  displayName: 'Publish symbols copy'
                  inputs:
                    SymbolsFolder: '$(Build.ArtifactStagingDirectory)'
                    SearchPattern: '**\*.pdb'
                    SymbolServerType: TeamServices

                - task: NuGetCommand@2
                  displayName: 'NuGet pack'
                  inputs:
                    command: pack
                    packagesToPack: package/Lepton.Jpeg.Rust.nuspec

                - task: 1ES.PublishNuGet@1
                  displayName: 'NuGet push'
                  condition: and(succeeded(), in(variables['Build.Reason'], 'Manual'), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
                  inputs:
                    packageParentPath: '$(Pipeline.Workspace)'
                    packagesToPush: '$(Build.ArtifactStagingDirectory)\*.nupkg'
                    publishVstsFeed: 'b87285d9-99ab-48db-a000-cb0cc8a2a1b5'
                    allowPackageConflicts: true
