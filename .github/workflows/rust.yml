name: Rust CI and Publish

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*.*.*"  # Trigger publish job on version tags like v1.2.3
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - uses: rust-lang/setup-rust@v1
        with:
          rust-version: stable
          targets: wasm32-wasip1,aarch64-unknown-linux-musl,x86_64-pc-windows-msvc,x86_64-unknown-linux-gnu
          components: rustfmt,clippy

      - name: Check formatting
        run: cargo fmt --check --all

      - name: Build default target
        run: cargo build --locked --workspace

      - name: Build wasm32-wasip1
        run: cargo build --locked --target wasm32-wasip1 --manifest-path lib/Cargo.toml

      - name: Build aarch64-unknown-linux-musl
        run: cargo build --locked --target aarch64-unknown-linux-musl --manifest-path lib/Cargo.toml

      - name: Build x86_64-pc-windows-msvc
        run: cargo build --locked --target x86_64-pc-windows-msvc --lib --workspace

      - name: Build x86_64-pc-windows-msvc release
        run: cargo build --locked --target x86_64-pc-windows-msvc --lib --workspace --release

      - name: Run tests
        run: cargo test --locked --workspace

  publish:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Rust
        uses: rust-lang/setup-rust@v1
        with:
          rust-version: stable

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATE_PUBLISH }}
        run: cargo publish --verbose --package lepton_jpeg